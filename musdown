#!/usr/bin/env python3

import os
import sys
import subprocess
import argparse
from pathlib import Path

# Constants
MUSIC_ROOT = Path.home() / "Music/YouTube"

def download_playlist(playlist_title, urls):
    output_template = str(MUSIC_ROOT / playlist_title / "%(playlist_index)03d - %(title)s.%(ext)s")

    cmd = [
        "yt-dlp",
        "-x",  # extract audio
        "--audio-format", "opus",
        "--audio-quality", "0",  # highest quality
        "--embed-thumbnail",
        "--add-metadata",
        "--download-archive", str(MUSIC_ROOT / playlist_title / ".musdown_archive.txt"),
        "-o", output_template,
        *urls
    ]

    print(f"\nDownloading playlist: {playlist_title}")
    print("URLs:")
    for u in urls:
        print(f" - {u}")
    print(f"\nOutput folder: {MUSIC_ROOT / playlist_title}\n")

    try:
        subprocess.run(cmd, check=True)
    except subprocess.CalledProcessError as e:
        print("Download failed:", e)

def main():
    parser = argparse.ArgumentParser(description="musdown - Music Playlist Downloader")
    parser.add_argument(
        "urls",
        metavar="URL",
        nargs="+",
        help="Playlist or video URLs to download"
    )
    parser.add_argument(
        "-t", "--title",
        required=True,
        help="Custom playlist title (used as folder name)"
    )

    args = parser.parse_args()
    download_playlist(args.title, args.urls)

if __name__ == "__main__":
    main()

